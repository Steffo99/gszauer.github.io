<!doctype html>
<html>
    <head>
        <script src="js/tweedle.js"></script>
        <script src="js/typed-signals.js"></script>

        <script src="js/pixi.js"></script>
        <script src="js/pixi-ui.js"></script>

        <script src="js/mainmenu.js"></script>
        <script src="js/game.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                border: 0;
                
                width: 100%;
                height: 100vh;

                /*background-color: #1d1d1d;*/
                background-color: #000000;
            }
        </style>

        <script type="module">
            PIXI.AbstractRenderer.defaultOptions.resolution = window.devicePixelRatio || 1;
            const app = new PIXI.Application();

            const targetWidth = 1126;
            const targetHeight = 2436;

            const FitContainerToWindow = (container) => {
                const { width, height } = app.screen;
                const targetAspect = targetWidth / targetHeight;
                const invTargetAspect = targetHeight / targetWidth;

                const isWidthConstrained = width < height * targetAspect;
                const isHeightConstrained = width * invTargetAspect > height;
                
                const actualWidth = isWidthConstrained ? width : height * targetAspect;
                const actualHeight =  isHeightConstrained ? height : width * invTargetAspect;

                container.scale.x = actualWidth / targetWidth;
                container.scale.y = actualHeight / targetHeight;
                
                container.x = app.screen.width / 2 - actualWidth / 2;
                container.y = app.screen.height / 2 - actualHeight / 2;
            };

            await app.init({ 
                resizeTo: document.body,//window, // Auto fill the screen
                autoDensity: true, // Handles high DPI screens
                //backgroundColor: 0x1d1d1d,
                backgroundColor: 0x000000,
            });

            document.body.appendChild(app.canvas);

            const altas1 = await PIXI.Assets.load('img/atlas1.png');
            PIXI.Assets.add({
                alias: 'atlas1',
                src: 'img/atlas1.json',
                data: {texture: altas1}
            });

            const altas2 = await PIXI.Assets.load('img/atlas2.png');
            PIXI.Assets.add({
                alias: 'atlas2',
                src: 'img/atlas2.json',
                data: {texture: altas2}
            });

            app.stage.removeChildren();
            const container = new PIXI.Container();
            container.width = targetWidth;
            container.height = targetHeight;
            FitContainerToWindow(container);
            app.stage.addChild(container);

            const menu = await CreateMainMenu(targetWidth, targetHeight);
            container.addChild(menu);

            const game = new Game();
            await game.Initialize(targetWidth, targetHeight);
            container.addChild(game.container);

            game.container.visible = false;

            menu.onPlay = () => {
                menu.visible = false;
                game.container.visible = true;
            };
            menu.onSettings = () => {
                console.log("SETTINGS");
            };
            menu.onTutorial = () => {
                console.log("TUTORIAL");
            };

            game.onReturnToMenu = () => {
                menu.visible = true;
                game.container.visible = false;
            }

            app.ticker.add((ticker) => {
                FitContainerToWindow(container);
            });
        </script>
    </head>
    <body>
    </body>
</html>